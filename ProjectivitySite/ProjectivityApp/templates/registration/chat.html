<!DOCTYPE html>
<html>
<head>
    {% csrf_token %}
<script>
    function getCSRFToken() {
        return document.querySelector('input[name="csrfmiddlewaretoken"]').value;
    }
</script>
    {% load static %}
    <title>Chat</title>
    <link rel="stylesheet" type="text/css" href="{% static 'style.css' %}">
    <link rel="stylesheet" type="text/css" href="contact.css">
    <link rel="icon" type="image/png" href="{% static 'background.png' %}">
    <link rel="icon" type="image/png" href="{% static 'iconuser.png' %}">
    <link rel="icon" type="image/png" href="{% static 'send.png' %}">
    <style>
        body {
            background-image: url("background.png");
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
        }
    </style>
</head>
<body>
    <style>
        .button-box {
            border: 2px solid #006400;
            background-color: #C8FFB4;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px;
            font-family: 'Berlin Sans FB Demi', sans-serif;
            font-size: 18px;
            color: black;
        }

        .add-button {
            border: 2px solid #006400;
            background-color: #C8FFB4;
            padding: 10px;
            font-weight: bold;
            border-radius: 5px;
            display: inline-block;
            margin: 10px;
            font-family: 'Berlin Sans FB Demi', sans-serif;
            font-size: 15px;
            color: black;
            margin-left: 150px;
        }

        .add-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        #home-button {
            background-color: #C8FFB4;
            color: black;
        }

        #home-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        #profil-button {
            float: left;
        }

        #chat-button {
            background-color: #006400;
            color: white; 
        }

        #humanitas-button {
            float: right;
            background-color: #C8FFB4;
            color: white; 
        }

        #humanitas-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        .button-box:hover {
            background-color: #32CD32;
        }

        #app-title {
            font-size: 30px;
            font-weight: bold;
            color: #006400;
            margin-top: 30px;
            margin-bottom: 20px;
            text-align: center;
        }

        #contact-title {
            font-size: 25px;
            color: black;
            margin-top: 70px;
            margin-bottom: 50px;
            text-align: center;
        }

        .container {
            margin: 0 auto;
            width: 80%;
            background-color: lightgreen;
            padding: 20px;
            border: 2px solid #006400;
        }

        .row {
            display: flex;
        }

        .col {
            flex: 1;
            margin: 10px;
            padding: 20px;
            background-color: #ccffcc;
            border: 2px solid #006400;
        }

        .title {
            font-size: 25px;
            font-weight: bold;
            color: black;
            text-align: center;
        }

        .chat-list {
            margin-top: 20px;
            margin-bottom: 40px;
            overflow-y: scroll;
        }

        .chat-title {
            font-weight: bold;
            font-size: 20px;
            color: #006400;
        }

        .modify-button {
            margin-left: 40px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            margin-bottom: 40px;
        }

        .modify-button img {
            width: 32px;
            height: 30px;
        }

        .add-chat-button {
            border: 2px solid #006400;
            background-color: #C8FFB4;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px;
            font-family: 'Berlin Sans FB Demi', sans-serif;
            font-size: 18px;
            color: black;
            margin-left: 120px;
        }

        #add-chat-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        .add-member-button {
            border: 2px solid #006400;
            background-color: #C8FFB4;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin: 10px;
            font-family: 'Berlin Sans FB Demi', sans-serif;
            font-size: 5px;
            margin-left: 50px;
            font-size: 18px;
            color: back;
        }

        #add-member-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        .delete-button {
            margin-left: 40px;
            border: none;
            background-color: transparent;
            cursor: pointer;
        }

        .delete-button img {
            width: 28px;
            height: 30px;
        }

        .chat-window {
            width: 800px;
            height: 200px;
            overflow-y: scroll;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .message-box {
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .message-textarea {
            width: 100%;
            padding: 10px;
        }

        .send-button {
            border: none;
            background-color: transparent;
            cursor: pointer;
            margin-top: 10px;
        }

        .send-button img {
            width: 30px;
            height: 32px;
        }

        .message {
            font-size: 18px;
            font-family: Calibri;
            color: darkgreen;
            background-color: lightgreen;
            padding: 10px;
            margin-bottom: 10px;
        }

        .invite-button {
            border: 2px solid #006400;
            background-color: #C8FFB4;
            padding: 5px;
            border-radius: 5px;
            display: inline-block;
            margin: 5px;
            font-family: 'Berlin Sans FB Demi', sans-serif;
            margin-left: 700px;
            margin-bottom: 20px;
            font-size: 12.5px;
            color: back;
        }

        .invite-button:hover {
            background-color: #32CD32;
            cursor: pointer;
        }

        .user-dropdown {
            position: relative;
            display: inline-block;
        }
          
        .user-dropdown .dropdown-item {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            padding: 12px 16px;
            z-index: 1;
        }
          
        .user-dropdown:hover .dropdown-item {
            display: block;
        }
          
        .user-dropdown .dropdown-item:hover {
            background-color: #e9e9e9;
        }
          
        .user-dropdown .dropdown-item:first-child {
            margin-top: 0;
        }
          
        .user-dropdown .dropdown-item:last-child {
            margin-bottom: 0;
        }
          
        .user-dropdown .dropdown-item.selected {
            background-color: #c8ffb4;
        }
          
        .user-dropdown .dropdown-item a {
            display: block;
            text-decoration: none;
            color: #000;
        }
          
        .user-dropdown .dropdown-item a:hover {
            text-decoration: underline;
        }
          
        .dropdown-item {
            cursor: pointer;
        }
        
        .dropdown-item:hover {
            background-color: #f1f1f1;
        }
        
        .dropdown-item.selected {
            background-color: #ccc;
        }

    </style>

    <div id="home-button" class="button-box">Home</div>
    <div class="button-box">
        <a href="taskuri.html" style="text-decoration: none; color: #006400;">Taskuri</a>
    </div>
    <div class="button-box">
        <a href="proiecte.html" style="text-decoration: none; color: #006400;">Proiecte</a>
    </div>
    <div class="button-box">
        <a href="sedinte.html" style="text-decoration: none; color: #006400;">Sedinte</a>
    </div>
    <div id="chat-button" class="button-box">
        <a href="chat.html" style="text-decoration: none; color: white;">Chat</a>
    </div>
    <div class="button-box">
        <a href="rapoarte.html" style="text-decoration: none; color: #006400;">Rapoarte</a>
    </div>
    <div id="profil-button" class="button-box">
        <img src="iconuser.png" alt="User Icon" style="width: 2em; height: 2em; vertical-align: middle; margin-right: 5px;">
        <a href="detalii_utilizator.html" style="text-decoration: none; color: #006400;">Profil</a>
    </div>    
    <div id="humanitas-button" class="button-box">
        <a href="contact.html" style="text-decoration: none; color: #006400;">HUMANITAS S.A.</a>
    </div>
    <div id="welcome-section">
        <h1 id="app-title">PROJECTIVITY</h1>
        <h2 id="contact-title">CHAT - FORUM</h2>
    </div>

    <div class="container">
        <div class="row">
            <div class="col">
                <div class="title">Chat</div>
                <div class="chat-list">
                    <div class="chat-item" id="chat-item-{{ cod_chat }}">
                        <span class="chat-title">Chat 1</span>
                        <button class="modify-button"><img src="modify.png" alt="Modify"></button>
                        <button class="delete-button"><img src="trash.png" alt="Delete"></button>
                    </div>
                    <div class="chat-item">
                        <span class="chat-title">Chat 2</span>
                        <button class="modify-button"><img src="modify.png" alt="Modify"></button>
                        <button class="delete-button"><img src="trash.png" alt="Delete"></button>
                    </div>
                </div>
                <button id="add-chat-button" class="button-box">
                <a>Adauga chat nou</a>
                </button>
                </div>
                <div class="col">
                    <span class="title">Chat Window</span> 
                    <button class="add-button" id="add-member-button">Adaugă membri noi</button>
                    <div class="user-dropdown">
                        {% for user in users %}
                        <div class="dropdown-item">
                            <a href="#">{{ user.cod_utilizator }}</a>
                        </div>
                        {% endfor %}
                    </div>
                    <form id="invite-form" data-chat-id="{{ cod_chat }}" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="invite-user" name="user" value="">
                        <button class="invite-button" type="submit">Invita</button>
                    </form>                                 
                    <div class="chat-window">
                        <div class="message">Mesaj 1</div>
                        <div class="message">Mesaj 2</div>
                        <div class="message">Mesaj 3</div>
                    </div>
                    <div class="message-box">
                        <textarea class="message-textarea" placeholder="Scrie un mesaj"></textarea>
                        <button class="send-button"><img src="send.png" alt="Send"></button>
                    </div>
                </div>
            </div>
        </div>
    
        <script>        
            const { Pool } = require('pg');
        
            const pool = new Pool({
                user: 'postgres',
                host: 'localhost',
                database: 'djangoapp',
                password: 'admin',
                port: 5432,
            });
        
            var current_user_id = null;

            if (userAuthenticated) {
                current_user_id = getUserId(); 
            }

            function addModifyAndDeleteButtons() {
                function setButtonBehavior(button) {
                    button.addEventListener('click', function() {
                        var chatTitleElement = button.parentNode.querySelector('.chat-title');
                        if (chatTitleElement.contentEditable === 'true') {
                            chatTitleElement.contentEditable = 'false';
                            chatTitleElement.style.backgroundColor = 'initial';
                        } else {
                            chatTitleElement.contentEditable = 'true';
                            chatTitleElement.style.backgroundColor = '#ccffcc';
                        }
                    });
                }
            
                var modifyButtons = document.querySelectorAll('.modify-button');
                modifyButtons.forEach(function(button) {
                    setButtonBehavior(button);
                });
            
                var deleteButtons = document.querySelectorAll('.delete-button');
                deleteButtons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        var confirmDelete = confirm('Sunteți sigur că doriți să ștergeți conversația?');
                        if (confirmDelete) {
                            var chatItem = button.closest('.chat-item');
                            chatItem.parentNode.removeChild(chatItem);
                            var chatTitle = button.parentNode.querySelector('.chat-title').innerText;
                            deleteChatFromDatabase(chatTitle);
                        }
                    });
                });
            }            
        
            function showChatMessages(chatTitleText) {
                var chatWindow = document.querySelector('.chat-window');
                chatWindow.innerHTML = '';
            
                if (current_user_id !== null && chat.cod_utilizator.includes(current_user_id)) {
                    fetch('/messages/' + chatTitleText)
                    .then(response => response.json())
                    .then(data => {
                        if (data.includes(current_user_id)) {
                            fetch('/messages/' + chatTitleText)
                        .then(response => response.json())
                        .then(data => {
                            data.forEach(message => {
                                var messageElement = document.createElement('div');
                                messageElement.textContent = message.mesaj;
                                messageElement.classList.add('message');
                                if (message.cod_utilizator === current_user_id) {
                                    messageElement.classList.add('right');
                                } else {
                                    messageElement.classList.add('left');
                                }
                                chatWindow.appendChild(messageElement);
                            });
                        });
                } else {
                    console.log('Utilizatorul curent nu este membru al chat-ului sau nu este autentificat.');
                }
            }
        }
            }           
        
            var addChatButton = document.getElementById('add-chat-button');
            addChatButton.addEventListener('click', function() {
                var chatTitle = prompt('Introduceți titlul chat-ului:');
                if (chatTitle) {
                    var chatItem = document.createElement('div');
                    chatItem.classList.add('chat-item');
        
                    var chatTitleContainer = document.createElement('div');
                    chatTitleContainer.classList.add('chat-title-container');
        
                    var chatTitleElement = document.createElement('span');
                    chatTitleElement.classList.add('chat-title');
                    chatTitleElement.innerText = chatTitle;
                    chatTitleContainer.appendChild(chatTitleElement);
        
                    var modifyButton = document.createElement('button');
                    modifyButton.classList.add('modify-button');
                    var modifyIcon = document.createElement('img');
                    modifyIcon.src = 'modify.png';
                    modifyIcon.alt = 'Modify';
                    modifyButton.appendChild(modifyIcon);
                    chatTitleContainer.appendChild(modifyButton);
        
                    var deleteButton = document.createElement('button');
                    deleteButton.classList.add('delete-button');
                    var deleteIcon = document.createElement('img');
                    deleteIcon.src = 'trash.png';
                    deleteIcon.alt = 'Delete';
                    deleteButton.appendChild(deleteIcon);
                    chatTitleContainer.appendChild(deleteButton);
            
                    chatItem.appendChild(chatTitleContainer);
                    document.querySelector('.chat-list').appendChild(chatItem);
            
                    addModifyAndDeleteButtons();

                    saveChatToDatabase(chatTitle);
                }
            });
            function saveChatToDatabase(chatTitle) {
                pool.query('INSERT INTO Chat (nume_chat, cod_utilizator) VALUES ($1, $2)', [chatTitle], (error, results) => {
                    if (error) {
                        console.error('Eroare la salvarea chat-ului:', error);
                    } else {
                        console.log('Chat salvat în baza de date');
                    }
                });
            }
            
            function deleteChatFromDatabase(chatTitle) {
                pool.query('DELETE FROM Chat WHERE nume_chat = $1 AND cod_utilizator = $2', [chatTitle], (error, results) => {
                    if (error) {
                        console.error('Eroare la ștergerea chat-ului:', error);
                    } else {
                        console.log('Chat șters din baza de date');
                    }
                });
            }
            
            var dropdownItems = document.querySelectorAll('.dropdown-item');
            var addMemberButton = document.getElementById('add-member-button');
            var userDropdown = document.querySelector('.user-dropdown');
            var inviteForm = document.getElementById('invite-form');
            var inviteUserInput = document.getElementById('invite-user');

            userDropdown.style.display = 'none';

            addMemberButton.addEventListener('click', function() {
                if (userDropdown.style.display === 'none') {
                  userDropdown.style.display = 'block';
                } else {
                  userDropdown.style.display = 'none';
                }
            });
        
            dropdownItems.forEach(function(item) {
                item.addEventListener('click', function() {
                  var selectedUser = item.querySelector('a').innerText;
                  inviteUserInput.value = selectedUser;
                  addMemberToChat(selectedUser);
                });
            });
        
            function addMemberToChat(selectedUser) {
                fetch('/get_users')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Utilizatori:', data);
                        userDropdown.innerHTML = '';
                        data.forEach(function (user) {
                            var dropdownItem = document.createElement('div');
                            dropdownItem.classList.add('dropdown-item');
                            var userLink = document.createElement('a');
                            userLink.href = '#';
                            userLink.innerText = user.cod_utilizator;
                            dropdownItem.appendChild(userLink);
                            userDropdown.appendChild(dropdownItem);
                        });
                    })
                    .catch(error => {
                        console.error('Eroare la obținerea utilizatorilor:', error);
                    });
            
                fetch('/chat/' + chatTitleText + '/add-member', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user: selectedUser
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Utilizatorul', selectedUser, 'a fost adăugat în chat.');
                        } else {
                            console.log('Eroare la adăugarea utilizatorului', selectedUser, 'în chat.');
                        }
                    })
                    .catch(error => {
                        console.error('Eroare la adăugarea utilizatorului în chat:', error);
                    });
            }

            function init() {
                pool.query('SELECT * FROM Chat WHERE cod_utilizator = $1', (error, results) => {
                    if (error) {
                        console.error('Eroare la obținerea chat-urilor:', error);
                    } else {
                        results.rows.forEach(chat => {
                            if (chat.cod_utilizator.includes(current_user_id)) {
                                var chatItem = document.createElement('div');
                                chatItem.classList.add('chat-item');
                            }
            
                            var chatTitleContainer = document.createElement('div');
                            chatTitleContainer.classList.add('chat-title-container');
            
                            var chatTitleElement = document.createElement('span');
                            chatTitleElement.classList.add('chat-title');
                            chatTitleElement.innerText = chat.nume_chat;
                            chatTitleContainer.appendChild(chatTitleElement);
            
                            var modifyButton = document.createElement('button');
                            modifyButton.classList.add('modify-button');
                            var modifyIcon = document.createElement('img');
                            modifyIcon.src = 'modify.png';
                            modifyIcon.alt = 'Modify';
                            modifyButton.appendChild(modifyIcon);
                            chatTitleContainer.appendChild(modifyButton);
            
                            var deleteButton = document.createElement('button');
                            deleteButton.classList.add('delete-button');
                            var deleteIcon = document.createElement('img');
                            deleteIcon.src = 'trash.png';
                            deleteIcon.alt = 'Delete';
                            deleteButton.appendChild(deleteIcon);
                            chatTitleContainer.appendChild(deleteButton);
            
                            chatItem.appendChild(chatTitleContainer);
                            document.querySelector('.chat-list').appendChild(chatItem);
                        });
            
                        addModifyAndDeleteButtons();
                    }
                });
            }
            
            init();
            
        </script>
    

<script>
    document.getElementById("home-button").classList.add("inactive");

    document.getElementById("home-button").addEventListener("click", function() {
        window.location.href = "home.html";
    });

    document.getElementById("profil-button").addEventListener("click", function() {
        window.location.href = "detalii_utilizator.html";
    });

    document.getElementById("humanitas-button").addEventListener("click", function() {
        window.location.href = "contact.html";
    });

    document.getElementById("info-utile-button").addEventListener("click", function() {
        window.location.href = "info_utile.html";
    });

    document.getElementById("proiect-button").addEventListener("click", function() {
        window.location.href = "proiecte.html";
    });

    document.getElementById("task-button").addEventListener("click", function() {
        window.location.href = "task.html";
    });

    document.getElementById("sedinte-button").addEventListener("click", function() {
        window.location.href = "sedinte.html";
    });

    document.getElementById("chat-button").addEventListener("click", function() {
        window.location.href = "proiecte.html";
    });

    document.getElementById("rapoarte-button").addEventListener("click", function() {
        window.location.href = "proiecte.html";
    });

    document.getElementById("profil-button").addEventListener("click", function() {
        window.location.href = "detalii_utilizator.html";
    });
</script>
</body>
</html>
